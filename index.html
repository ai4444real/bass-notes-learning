<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bass Notes Learning</title>

    <!-- abcjs Library for Music Notation (sostituisce VexFlow) -->
    <script src="https://cdn.jsdelivr.net/npm/abcjs@6.2.3/dist/abcjs-basic-min.js"></script>

    <!-- ========================================
         CSS SECTION
         Organizzato per componenti
         ======================================== -->
    <style>
        /* ===== BASE & RESET ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #8B4513;
            --primary-dark: #654321;
            --success: #10b981;
            --error: #ef4444;
            --text-dark: #1f2937;
            --text-light: #6b7280;
            --bg-light: #f9fafb;
            --border-radius: 8px;
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            color: var(--text-dark);
        }

        /* ===== CONTAINER PRINCIPALE ===== */
        .app-container {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: var(--shadow-lg);
            max-width: 600px;
            width: 100%;
        }

        /* ===== HEADER ===== */
        .app-header {
            text-align: center;
            margin-bottom: 6px;
            padding-bottom: 4px;
            border-bottom: 2px solid var(--bg-light);
        }

        .app-header h1 {
            color: var(--primary);
            font-size: 1.2em;
            margin-bottom: 2px;
        }

        .score-display {
            font-size: 0.85em;
            color: var(--text-light);
            font-weight: bold;
        }

        .score-display .score {
            color: var(--primary);
            font-size: 1.2em;
        }

        /* ===== EXERCISE AREA ===== */
        .exercise-container {
            background: var(--bg-light);
            border-radius: var(--border-radius);
            padding: 6px;
            margin: 4px 0;
        }

        .exercise-type {
            text-align: center;
            color: var(--text-light);
            font-size: 0.65em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .exercise-question {
            text-align: center;
            font-size: 0.95em;
            color: var(--text-dark);
            margin-bottom: 0;
            font-weight: 500;
        }

        /* ===== STAFF CONTAINER (VexFlow) ===== */
        #staff-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 2px 5px;
            margin: 2px 0;
            box-shadow: var(--shadow);
            min-height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #staff-canvas {
            width: 100%;
            max-width: 400px;
        }

        #staff-canvas svg {
            display: block;
            margin: 0 auto;
        }

        .hint-controls {
            text-align: center;
            margin: 2px 0 0 0;
        }

        .checkbox-label {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            color: var(--text-light);
            cursor: pointer;
            user-select: none;
        }

        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .note-hint {
            text-align: center;
            margin-top: 3px;
            font-size: 0.85em;
            font-weight: bold;
            color: var(--primary);
            font-family: 'Courier New', monospace;
        }

        /* ===== FRETTING DISPLAY ===== */
        .fretting-display {
            text-align: center;
            background: white;
            border-radius: var(--border-radius);
            padding: 10px;
            margin: 4px 0;
            box-shadow: var(--shadow);
        }

        .fretting-display .fretting {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--primary);
            font-family: 'Courier New', monospace;
        }

        /* ===== VIRTUAL KEYBOARD ===== */
        .keyboard-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 8px;
            margin: 4px 0;
            box-shadow: var(--shadow);
        }

        .keyboard-label {
            text-align: center;
            color: var(--text-light);
            font-size: 0.7em;
            margin-bottom: 4px;
        }

        .current-input {
            text-align: center;
            font-size: 1.4em;
            font-weight: bold;
            color: var(--primary);
            min-height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 6px;
            font-family: 'Courier New', monospace;
        }

        .keyboard-section {
            margin: 6px 0;
        }

        .keyboard-section-label {
            font-size: 0.65em;
            color: var(--text-light);
            margin-bottom: 3px;
            text-align: center;
        }

        .keyboard-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            justify-content: center;
        }

        .key-btn {
            background: var(--bg-light);
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 8px 12px;
            min-width: 40px;
            font-size: 0.85em;
            font-weight: bold;
            color: var(--text-dark);
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .key-btn:hover {
            background: #e5e7eb;
            transform: translateY(-2px);
        }

        .key-btn:active {
            transform: translateY(0);
            background: var(--primary);
            color: white;
        }

        .key-btn.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .key-btn.small {
            min-width: 32px;
            padding: 6px 8px;
            font-size: 0.75em;
        }

        /* ===== ACTION BUTTONS ===== */
        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
            margin: 6px 0;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 0.8em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: var(--shadow);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(139, 69, 19, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-secondary:hover {
            box-shadow: 0 6px 12px rgba(107, 114, 128, 0.4);
        }

        /* ===== FEEDBACK AREA ===== */
        .feedback {
            background: var(--bg-light);
            border-radius: var(--border-radius);
            padding: 8px;
            margin: 4px 0;
            text-align: center;
            display: none;
            animation: fadeIn 0.3s;
        }

        .feedback.show {
            display: block;
        }

        .feedback.success {
            background: #d1fae5;
            border: 1px solid var(--success);
        }

        .feedback.error {
            background: #fee2e2;
            border: 1px solid var(--error);
        }

        .feedback-icon {
            font-size: 1.5em;
            margin-bottom: 3px;
        }

        .feedback-message {
            font-size: 0.85em;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .feedback-details {
            font-size: 0.75em;
            color: var(--text-light);
            margin-top: 3px;
        }

        .alternatives {
            margin-top: 4px;
            padding: 4px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 4px;
        }

        .alternatives-title {
            font-weight: bold;
            margin-bottom: 2px;
            color: var(--text-dark);
            font-size: 0.85em;
        }

        .alternatives-list {
            font-family: 'Courier New', monospace;
            color: var(--primary);
            font-weight: bold;
            font-size: 0.85em;
        }

        /* ===== ANIMATIONS ===== */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 480px) {
            .app-container {
                padding: 10px;
            }

            .app-header h1 {
                font-size: 1.1em;
            }

            .exercise-question {
                font-size: 0.9em;
            }

            .fretting-display .fretting {
                font-size: 2em;
            }

            .current-input {
                font-size: 1.3em;
            }

            .key-btn {
                min-width: 38px;
                padding: 7px 10px;
                font-size: 0.8em;
            }

            .btn {
                padding: 7px 14px;
                font-size: 0.75em;
            }

            .settings-sections {
                gap: 4px;
            }
        }

        /* ===== SETTINGS PANEL ===== */
        .settings-panel {
            background: var(--bg-light);
            border-radius: var(--border-radius);
            padding: 8px;
            margin: 6px 0;
        }

        .settings-title {
            font-size: 0.75em;
            font-weight: bold;
            color: var(--text-dark);
            margin-bottom: 4px;
            text-align: center;
        }

        .settings-sections {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .settings-section {
            margin: 0;
        }

        .settings-label {
            font-size: 0.7em;
            color: var(--text-light);
            margin-bottom: 4px;
            display: block;
            font-weight: 600;
            text-align: center;
        }

        .radio-group {
            display: flex;
            gap: 3px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .radio-option {
            position: relative;
        }

        .radio-option input[type="radio"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
        }

        .radio-option label {
            display: inline-block;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.65em;
            font-weight: 600;
            color: var(--text-dark);
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .radio-option label:hover {
            background: #f3f4f6;
            border-color: var(--primary);
        }

        .radio-option input[type="radio"]:checked + label {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* ===== HIDDEN UTILITY ===== */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- ========================================
         HTML SECTION
         Struttura dell'applicazione
         ======================================== -->
    <div class="app-container">
        <!-- Header with Score -->
        <header class="app-header">
            <h1>üé∏ Bass Notes Learning</h1>
            <div class="score-display">
                Score: <span class="score" id="score">0</span>
            </div>
        </header>

        <!-- Settings Panel -->
        <div class="settings-panel">
            <div class="settings-title">‚öôÔ∏è Impostazioni</div>

            <div class="settings-sections">
                <!-- Exercise Type Selection -->
                <div class="settings-section">
                    <label class="settings-label">Tipo</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="exercise-type-1" name="exercise-type" value="1" checked>
                            <label for="exercise-type-1">Nota‚ÜíFret</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="exercise-type-2" name="exercise-type" value="2">
                            <label for="exercise-type-2">Fret‚ÜíNota</label>
                        </div>
                    </div>
                </div>

                <!-- Fret Range Selection -->
                <div class="settings-section">
                    <label class="settings-label">Range</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="fret-range-9" name="fret-range" value="9" checked>
                            <label for="fret-range-9">9</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="fret-range-12" name="fret-range" value="12">
                            <label for="fret-range-12">12</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="fret-range-20" name="fret-range" value="20">
                            <label for="fret-range-20">20</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Exercise Container -->
        <div class="exercise-container">
            <div class="exercise-type" id="exercise-type">Loading...</div>
            <div class="exercise-question" id="exercise-question">Preparazione...</div>
        </div>

        <!-- Staff Container (for VexFlow) -->
        <div id="staff-container" class="hidden">
            <div id="staff-canvas"></div>
            <div class="hint-controls">
                <input type="checkbox" id="show-hint-checkbox">
            </div>
            <div id="note-hint" class="note-hint hidden"></div>
        </div>

        <!-- Fretting Display (for Type 2 exercise) -->
        <div id="fretting-display" class="fretting-display hidden">
            <div class="fretting" id="fretting-text">--</div>
        </div>

        <!-- Virtual Keyboard -->
        <div id="keyboard-container" class="keyboard-container">
            <!-- Keyboard will be rendered by JavaScript -->
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn" id="confirm-btn">Conferma</button>
            <button class="btn btn-secondary" id="solution-btn">Soluzione</button>
            <button class="btn btn-secondary" id="skip-btn">Salta</button>
        </div>

        <!-- Feedback Area -->
        <div id="feedback" class="feedback">
            <div class="feedback-icon" id="feedback-icon">‚úì</div>
            <div class="feedback-message" id="feedback-message">Messaggio</div>
            <div class="feedback-details" id="feedback-details"></div>
        </div>

        <!-- Next Exercise Button (shown after feedback) -->
        <div class="action-buttons hidden" id="next-container">
            <button class="btn" id="next-btn">Prossimo Esercizio</button>
        </div>
    </div>

    <!-- ========================================
         JAVASCRIPT SECTION
         Architettura modulare con classi
         ======================================== -->
    <script>
        'use strict';

        // =====================================
        // DATA LAYER: MusicTheory
        // Gestisce conversioni note ‚Üî fretting
        // =====================================
        class MusicTheory {
            constructor() {
                // Note naturali (no accidenti)
                this.NOTES = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];

                // Offset in semitoni da C
                this.NOTE_OFFSETS = {
                    'C': 0, 'D': 2, 'E': 4, 'F': 5,
                    'G': 7, 'A': 9, 'B': 11
                };

                // ACCORDATURA STANDARD BASSO 4 CORDE (da pi√π bassa a pi√π alta)
                // Valori MIDI verificati - QUESTA √à LA "BIBBIA" DI RIFERIMENTO:
                //   e0 (E string, fret 0) ‚Üí E1 (MIDI 28)
                //   a0 (A string, fret 0) ‚Üí A1 (MIDI 33)
                //   d0 (D string, fret 0) ‚Üí D2 (MIDI 38)
                //   g0 (G string, fret 0) ‚Üí G2 (MIDI 43)
                this.TUNING = {
                    'e': 28,  // E1 - corda pi√π bassa
                    'a': 33,  // A1
                    'd': 38,  // D2
                    'g': 43   // G2 - corda pi√π alta
                };

                this.MAX_FRETS = 20;
            }

            /**
             * Converte fretting in nota
             * @param {string} fretting - Es: "a3", "e0", "d12"
             * @returns {string|null} - Es: "C2", "E1", null se invalido
             */
            frettingToNote(fretting) {
                if (!fretting || fretting.length < 2) return null;

                const stringName = fretting[0].toLowerCase();
                const fretNumber = parseInt(fretting.substring(1));

                if (!(stringName in this.TUNING)) return null;
                if (isNaN(fretNumber) || fretNumber < 0 || fretNumber > this.MAX_FRETS) {
                    return null;
                }

                // Calcola semitoni assoluti
                const absoluteSemitone = this.TUNING[stringName] + fretNumber;

                // Converti in nota + ottava
                return this._semitonesToNote(absoluteSemitone);
            }

            /**
             * Converte nota in tutti i fretting possibili
             * @param {string} note - Es: "C2", "E1", "G3"
             * @returns {string[]} - Es: ["a3", "e8", "d13"]
             */
            noteToFrettings(note) {
                if (!note || note.length < 2) return [];

                const noteName = note[0].toUpperCase();
                const octave = parseInt(note.substring(1));

                if (!this.NOTES.includes(noteName) || isNaN(octave)) {
                    return [];
                }

                // Calcola semitoni assoluti della nota target
                const targetSemitone = this._noteToSemitones(noteName, octave);
                const frettings = [];

                // Prova ogni corda
                for (const [stringName, openSemitone] of Object.entries(this.TUNING)) {
                    const fretNumber = targetSemitone - openSemitone;

                    if (fretNumber >= 0 && fretNumber <= this.MAX_FRETS) {
                        frettings.push(`${stringName}${fretNumber}`);
                    }
                }

                return frettings;
            }

            /**
             * Genera nota random nel range del basso (con posizioni valide nel maxFrets corrente)
             * @returns {string} - Es: "C2", "E3"
             */
            getRandomNote() {
                const allNotes = this._generateAllNotes();

                // Filtra solo note che hanno almeno una posizione valida con maxFrets corrente
                const validNotes = allNotes.filter(note => {
                    const frettings = this.noteToFrettings(note);
                    return frettings.length > 0;
                });

                if (validNotes.length === 0) {
                    // Fallback: ritorna E1 che √® sempre valido (e0)
                    return 'E1';
                }

                return validNotes[Math.floor(Math.random() * validNotes.length)];
            }

            /**
             * Genera fretting random (solo note naturali)
             * @returns {string} - Es: "a5", "d12"
             */
            getRandomFretting() {
                // Genera finch√© non troviamo un fretting che corrisponde a una nota naturale
                let fretting, note;
                let attempts = 0;
                const maxAttempts = 100;

                do {
                    const strings = Object.keys(this.TUNING);
                    const randomString = strings[Math.floor(Math.random() * strings.length)];
                    const randomFret = Math.floor(Math.random() * (this.MAX_FRETS + 1));
                    fretting = `${randomString}${randomFret}`;
                    note = this.frettingToNote(fretting);
                    attempts++;
                } while (!note && attempts < maxAttempts);

                // Fallback sicuro se non troviamo una nota valida
                return note ? fretting : 'e0';  // e0 (fretting) produce sempre E0 (nota naturale)
            }

            /**
             * Valida formato nota
             * @param {string} note - Es: "C2"
             * @returns {boolean}
             */
            isValidNote(note) {
                if (!note || note.length < 2) return false;
                const noteName = note[0].toUpperCase();
                const octave = parseInt(note.substring(1));
                return this.NOTES.includes(noteName) && !isNaN(octave) && octave >= 0 && octave <= 8;
            }

            /**
             * Valida formato fretting
             * @param {string} fretting - Es: "a3"
             * @returns {boolean}
             */
            isValidFretting(fretting) {
                if (!fretting || fretting.length < 2) return false;
                const stringName = fretting[0].toLowerCase();
                const fretNumber = parseInt(fretting.substring(1));
                return (stringName in this.TUNING) &&
                       !isNaN(fretNumber) &&
                       fretNumber >= 0 &&
                       fretNumber <= this.MAX_FRETS;
            }

            // ===== PRIVATE METHODS =====

            _semitonesToNote(semitones) {
                // MIDI numbering: semitone 0 = C-1, semitone 12 = C0, semitone 24 = C1, etc.
                // Formula: octave = floor(semitones / 12) - 1
                const octave = Math.floor(semitones / 12) - 1;
                const noteIndex = semitones % 12;

                // Map semitone in nota (solo naturali)
                const semitonesToNotes = {
                    0: 'C', 2: 'D', 4: 'E', 5: 'F',
                    7: 'G', 9: 'A', 11: 'B'
                };

                const noteName = semitonesToNotes[noteIndex];
                return noteName ? `${noteName}${octave}` : null;
            }

            _noteToSemitones(noteName, octave) {
                // Inverse of _semitonesToNote: add 1 to octave for MIDI numbering
                return (octave + 1) * 12 + this.NOTE_OFFSETS[noteName];
            }

            _generateAllNotes() {
                const notes = [];
                // Range: E1 (MIDI 28) to E4 (MIDI 64) - standard 4-string bass range
                // e0 ‚Üí E1 (lowest), g20 ‚Üí D#4 (MIDI 63, highest fret)
                for (let semitone = 28; semitone <= 64; semitone++) {
                    const note = this._semitonesToNote(semitone);
                    if (note) notes.push(note);
                }
                return notes;
            }
        }

        // =====================================
        // PRESENTATION LAYER: StaffRenderer
        // Wrapper per abcjs (sostituisce VexFlow)
        // =====================================
        class StaffRenderer {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
            }

            /**
             * Renderizza una nota sul pentagramma usando abcjs
             * @param {string} note - Es: "C2", "E1", "F#3"
             */
            render(note) {
                if (!note) return;

                // Pulisci container
                this.container.innerHTML = '';

                // Converti nota in formato ABC (es: "E1" ‚Üí "E,,")
                const abcNote = this._toABCNotation(note);

                // Crea stringa ABC completa
                const abcString = `X:1\nL:1/1\nK:bass\n${abcNote}|]`;

                // Renderizza con abcjs
                ABCJS.renderAbc(this.container.id, abcString, {
                    scale: 0.75,
                    staffwidth: 280,
                    responsive: 'resize',
                    paddingtop: 0,
                    paddingbottom: 0,
                    paddingleft: 0,
                    paddingright: 0
                });
            }

            /**
             * Pulisce il pentagramma
             */
            clear() {
                this.container.innerHTML = '';
            }

            // ===== PRIVATE METHODS =====

            _toABCNotation(note) {
                // Converti notazione scientifica (E1, C#2, etc.) ‚Üí ABC notation
                // In ABC: virgole (,) abbassano l'ottava, apostrofi (') alzano
                //
                // Formula per bass clef in ABC:
                // - Ottava 1 (E1, A1): usa ,, (due virgole)
                // - Ottava 2 (D2, G2, C2): usa , (una virgola)
                // - Ottava 3: nessun modificatore
                // - Ottava 4: usa ' (apostrofo)

                // Parse nota (supporta C2, C#2, Cb2, Cs2, Cf2, etc.)
                let noteName, octave, accidental = '';

                if (note.length >= 3 && (note[1] === '#' || note[1] === 'b' || note[1] === 's' || note[1] === 'S' || note[1] === 'f' || note[1] === 'F')) {
                    // Nota con alterazione: C#2, Db3, Cs2 (sharp), Cf2 (flat), etc.
                    noteName = note[0].toUpperCase();
                    const acc = note[1].toLowerCase();
                    // Converti notazione URL: s‚Üí^, f‚Üí_ (ABC usa ^ per sharp, _ per flat)
                    if (acc === 's' || acc === '#') accidental = '^';
                    else if (acc === 'f' || acc === 'b') accidental = '_';
                    octave = parseInt(note.substring(2));
                } else {
                    // Nota naturale: C2, D3, etc.
                    noteName = note[0].toUpperCase();
                    octave = parseInt(note.substring(1));
                }

                // Validazione input
                if (!noteName || isNaN(octave)) {
                    console.error(`Nota invalida: "${note}". Usa formato: C2, E1, C#3, etc.`);
                    return 'C,'; // fallback
                }

                // Calcola modificatore ottava per ABC
                // Formula: commas = 3 - octave (negativo = apostrofi)
                const octaveModifier = 3 - octave;
                let modifier = '';

                if (octaveModifier > 0) {
                    // Usa virgole (abbassa ottava)
                    modifier = ','.repeat(octaveModifier);
                } else if (octaveModifier < 0) {
                    // Usa apostrofi (alza ottava)
                    modifier = "'".repeat(-octaveModifier);
                }
                // Se octaveModifier === 0, nessun modificatore

                // Costruisci stringa ABC: [accidentale]NotaNome[modificatore]
                return `${accidental}${noteName}${modifier}`;
            }
        }

        // =====================================
        // PRESENTATION LAYER: VirtualKeyboard
        // Base class per tastiere input
        // =====================================
        class VirtualKeyboard {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                this.currentInput = '';
                this.onInputChange = null;  // Callback
            }

            /**
             * Renderizza la tastiera
             */
            render() {
                // Override in subclass
            }

            /**
             * Gestisce input di un carattere/numero
             */
            handleInput(value) {
                this.currentInput += value;
                this._updateDisplay();
                if (this.onInputChange) {
                    this.onInputChange(this.currentInput);
                }
            }

            /**
             * Reset input corrente
             */
            reset() {
                this.currentInput = '';
                this._updateDisplay();
                if (this.onInputChange) {
                    this.onInputChange(this.currentInput);
                }
            }

            /**
             * Backspace
             */
            backspace() {
                this.currentInput = this.currentInput.slice(0, -1);
                this._updateDisplay();
                if (this.onInputChange) {
                    this.onInputChange(this.currentInput);
                }
            }

            /**
             * Ottiene input corrente
             */
            getValue() {
                return this.currentInput;
            }

            /**
             * Setta input programmaticamente
             */
            setValue(value) {
                this.currentInput = value;
                this._updateDisplay();
            }

            // ===== PRIVATE METHODS =====

            _updateDisplay() {
                const display = this.container.querySelector('.current-input');
                if (display) {
                    display.textContent = this.currentInput || '--';
                }
            }

            _createButton(text, onClick, className = '') {
                const btn = document.createElement('button');
                btn.className = `key-btn ${className}`;
                btn.textContent = text;
                btn.onclick = onClick;
                return btn;
            }
        }

        // =====================================
        // FrettingKeyboard: Input per fretting
        // =====================================
        class FrettingKeyboard extends VirtualKeyboard {
            constructor(containerId, maxFrets = 20) {
                super(containerId);
                this.maxFrets = maxFrets;
            }

            render() {
                this.container.innerHTML = `
                    <div class="keyboard-label">Inserisci il fretting</div>
                    <div class="current-input">--</div>

                    <div class="keyboard-section">
                        <div class="keyboard-section-label">Corda</div>
                        <div class="keyboard-buttons" id="string-buttons"></div>
                    </div>

                    <div class="keyboard-section">
                        <div class="keyboard-section-label">Fret (0-${this.maxFrets})</div>
                        <div class="keyboard-buttons" id="fret-buttons"></div>
                    </div>

                    <div class="keyboard-section">
                        <div class="keyboard-buttons" id="control-buttons"></div>
                    </div>
                `;

                // Bottoni corde
                const stringContainer = this.container.querySelector('#string-buttons');
                ['e', 'a', 'd', 'g'].forEach(str => {
                    stringContainer.appendChild(
                        this._createButton(str.toUpperCase(), () => {
                            if (this.currentInput.length === 0) {
                                this.handleInput(str);
                            }
                        })
                    );
                });

                // Bottoni fret (0 fino a maxFrets)
                const fretContainer = this.container.querySelector('#fret-buttons');
                for (let i = 0; i <= this.maxFrets; i++) {
                    fretContainer.appendChild(
                        this._createButton(i.toString(), () => {
                            if (this.currentInput.length > 0 && this.currentInput.length < 3) {
                                this.handleInput(i.toString());
                            }
                        }, 'small')
                    );
                }

                // Bottoni controllo
                const controlContainer = this.container.querySelector('#control-buttons');
                controlContainer.appendChild(
                    this._createButton('Reset', () => this.reset())
                );
                controlContainer.appendChild(
                    this._createButton('‚Üê', () => this.backspace())
                );
            }
        }

        // =====================================
        // NoteKeyboard: Input per note
        // =====================================
        class NoteKeyboard extends VirtualKeyboard {
            render() {
                this.container.innerHTML = `
                    <div class="keyboard-label">Inserisci la nota</div>
                    <div class="current-input">--</div>

                    <div class="keyboard-section">
                        <div class="keyboard-section-label">Nota</div>
                        <div class="keyboard-buttons" id="note-buttons"></div>
                    </div>

                    <div class="keyboard-section">
                        <div class="keyboard-section-label">Ottava (opzionale per +1 punto)</div>
                        <div class="keyboard-buttons" id="octave-buttons"></div>
                    </div>

                    <div class="keyboard-section">
                        <div class="keyboard-buttons" id="control-buttons"></div>
                    </div>
                `;

                // Bottoni note
                const noteContainer = this.container.querySelector('#note-buttons');
                ['A', 'B', 'C', 'D', 'E', 'F', 'G'].forEach(note => {
                    noteContainer.appendChild(
                        this._createButton(note, () => {
                            if (this.currentInput.length === 0) {
                                this.handleInput(note);
                            }
                        })
                    );
                });

                // Bottoni ottave
                const octaveContainer = this.container.querySelector('#octave-buttons');
                for (let i = 1; i <= 5; i++) {
                    octaveContainer.appendChild(
                        this._createButton(i.toString(), () => {
                            if (this.currentInput.length === 1) {
                                this.handleInput(i.toString());
                            }
                        })
                    );
                }

                // Bottoni controllo
                const controlContainer = this.container.querySelector('#control-buttons');
                controlContainer.appendChild(
                    this._createButton('Reset', () => this.reset())
                );
                controlContainer.appendChild(
                    this._createButton('‚Üê', () => this.backspace())
                );
            }
        }

        // =====================================
        // BUSINESS LOGIC: Exercise Base Class
        // =====================================
        class Exercise {
            constructor(musicTheory) {
                this.musicTheory = musicTheory;
                this.currentQuestion = null;
                this.currentAnswer = null;
            }

            /**
             * Genera una nuova domanda
             */
            generateQuestion() {
                // Override in subclass
            }

            /**
             * Valida la risposta utente
             * @param {string} userAnswer
             * @returns {object} - {correct: boolean, points: number, message: string, details: object}
             */
            validateAnswer(userAnswer) {
                // Override in subclass
            }

            /**
             * Ottiene il tipo di esercizio
             */
            getType() {
                return 'Base Exercise';
            }
        }

        // =====================================
        // Esercizio Tipo 1: Nota ‚Üí Fretting
        // =====================================
        class NoteToFrettingExercise extends Exercise {
            generateQuestion() {
                const note = this.musicTheory.getRandomNote();
                const correctFrettings = this.musicTheory.noteToFrettings(note);

                this.currentQuestion = note;
                this.currentAnswer = correctFrettings;

                return {
                    type: 'note-to-fretting',
                    note: note,
                    question: `Qual √® il fretting per questa nota?`
                };
            }

            validateAnswer(userAnswer) {
                if (!userAnswer) {
                    return {
                        correct: false,
                        points: 0,
                        message: 'Nessuna risposta inserita',
                        details: {}
                    };
                }

                const isCorrect = this.currentAnswer.includes(userAnswer.toLowerCase());

                return {
                    correct: isCorrect,
                    points: isCorrect ? 1 : 0,
                    message: isCorrect ?
                        `Corretto! ${userAnswer} √® giusto!` :
                        `Sbagliato. ${userAnswer} non corrisponde a ${this.currentQuestion}`,
                    details: {
                        correctAnswers: this.currentAnswer,
                        userAnswer: userAnswer,
                        note: this.currentQuestion
                    }
                };
            }

            getType() {
                return 'Esercizio Tipo 1: Nota ‚Üí Fretting';
            }
        }

        // =====================================
        // Esercizio Tipo 2: Fretting ‚Üí Nota
        // =====================================
        class FrettingToNoteExercise extends Exercise {
            generateQuestion() {
                const fretting = this.musicTheory.getRandomFretting();
                const correctNote = this.musicTheory.frettingToNote(fretting);

                this.currentQuestion = fretting;
                this.currentAnswer = correctNote;

                return {
                    type: 'fretting-to-note',
                    fretting: fretting,
                    question: `Che nota √® il fretting ${fretting}?`
                };
            }

            validateAnswer(userAnswer) {
                if (!userAnswer) {
                    return {
                        correct: false,
                        points: 0,
                        message: 'Nessuna risposta inserita',
                        details: {}
                    };
                }

                const correctNote = this.currentAnswer;
                const correctNoteName = correctNote[0];
                const correctOctave = correctNote.substring(1);

                const userNoteName = userAnswer[0];
                const userOctave = userAnswer.substring(1);

                let correct = false;
                let points = 0;
                let message = '';

                if (userNoteName.toUpperCase() === correctNoteName && userOctave === correctOctave) {
                    // Risposta completa corretta
                    correct = true;
                    points = 2;
                    message = `Perfetto! ${userAnswer} √® corretto con l'ottava!`;
                } else if (userNoteName.toUpperCase() === correctNoteName) {
                    // Solo nota corretta
                    correct = true;
                    points = 1;
                    message = `Buono! ${userNoteName} √® corretto. La risposta completa √® ${correctNote} (+1 punto invece di +2)`;
                } else {
                    // Sbagliato
                    message = `Sbagliato. La risposta corretta √® ${correctNote}`;
                }

                return {
                    correct: correct,
                    points: points,
                    message: message,
                    details: {
                        correctAnswer: correctNote,
                        userAnswer: userAnswer,
                        fretting: this.currentQuestion
                    }
                };
            }

            getType() {
                return 'Esercizio Tipo 2: Fretting ‚Üí Nota';
            }
        }

        // =====================================
        // STATE: ScoreManager
        // =====================================
        class ScoreManager {
            constructor() {
                this.score = 0;
                this.totalExercises = 0;
                this.correctExercises = 0;
            }

            addPoints(points) {
                this.score += points;
                this.totalExercises++;
                if (points > 0) {
                    this.correctExercises++;
                }
                this._updateDisplay();
            }

            reset() {
                this.score = 0;
                this.totalExercises = 0;
                this.correctExercises = 0;
                this._updateDisplay();
            }

            getStats() {
                const accuracy = this.totalExercises > 0 ?
                    Math.round((this.correctExercises / this.totalExercises) * 100) : 0;

                return {
                    score: this.score,
                    total: this.totalExercises,
                    correct: this.correctExercises,
                    accuracy: accuracy
                };
            }

            _updateDisplay() {
                const scoreElement = document.getElementById('score');
                if (scoreElement) {
                    scoreElement.textContent = this.score;

                    // Animazione
                    scoreElement.style.transform = 'scale(1.3)';
                    setTimeout(() => {
                        scoreElement.style.transform = 'scale(1)';
                    }, 200);
                }
            }
        }

        // =====================================
        // ORCHESTRATOR: App
        // Coordina tutti i componenti
        // =====================================
        class App {
            constructor() {
                // Inizializza componenti
                this.musicTheory = new MusicTheory();
                this.staffRenderer = new StaffRenderer('staff-canvas');
                this.scoreManager = new ScoreManager();

                // Esercizi disponibili
                this.exercises = [
                    new NoteToFrettingExercise(this.musicTheory),
                    new FrettingToNoteExercise(this.musicTheory)
                ];

                this.currentExercise = null;
                this.currentKeyboard = null;

                // Settings
                this.settings = {
                    exerciseType: 1,  // Default: Type 1 (Nota ‚Üí Fretting)
                    maxFrets: 9       // Default: 9 frets (Facile)
                };

                // UI Elements
                this.elements = {
                    exerciseType: document.getElementById('exercise-type'),
                    exerciseQuestion: document.getElementById('exercise-question'),
                    staffContainer: document.getElementById('staff-container'),
                    noteHint: document.getElementById('note-hint'),
                    frettingDisplay: document.getElementById('fretting-display'),
                    frettingText: document.getElementById('fretting-text'),
                    keyboardContainer: document.getElementById('keyboard-container'),
                    confirmBtn: document.getElementById('confirm-btn'),
                    solutionBtn: document.getElementById('solution-btn'),
                    skipBtn: document.getElementById('skip-btn'),
                    nextBtn: document.getElementById('next-btn'),
                    nextContainer: document.getElementById('next-container'),
                    feedback: document.getElementById('feedback'),
                    feedbackIcon: document.getElementById('feedback-icon'),
                    feedbackMessage: document.getElementById('feedback-message'),
                    feedbackDetails: document.getElementById('feedback-details')
                };

                this._setupEventListeners();
            }

            /**
             * Inizializza l'app
             */
            start() {
                console.log('üé∏ Bass Notes Learning - Started!');
                this.startNewExercise();
            }

            /**
             * Inizia un nuovo esercizio
             */
            startNewExercise() {
                // Leggi settings correnti
                this._readSettings();

                // Scegli esercizio in base ai settings
                const exerciseIndex = this.settings.exerciseType - 1;  // Type 1 = index 0, Type 2 = index 1
                this.currentExercise = this.exercises[exerciseIndex];

                // Imposta max frets nella MusicTheory
                this.musicTheory.MAX_FRETS = this.settings.maxFrets;

                // Genera domanda
                const question = this.currentExercise.generateQuestion();

                // Reset UI
                this._resetUI();

                // Mostra tipo esercizio
                this.elements.exerciseType.textContent = this.currentExercise.getType();
                this.elements.exerciseQuestion.textContent = question.question;

                // Setup UI specifica per tipo
                if (question.type === 'note-to-fretting') {
                    this._setupNoteToFrettingUI(question);
                } else if (question.type === 'fretting-to-note') {
                    this._setupFrettingToNoteUI(question);
                }
            }

            /**
             * Conferma risposta
             */
            confirmAnswer() {
                const userAnswer = this.currentKeyboard.getValue();

                if (!userAnswer) {
                    alert('Inserisci una risposta prima di confermare');
                    return;
                }

                // Valida risposta
                const result = this.currentExercise.validateAnswer(userAnswer);

                // Aggiorna score
                this.scoreManager.addPoints(result.points);

                // Mostra feedback
                this._showFeedback(result);

                // Disabilita input
                this.elements.confirmBtn.disabled = true;
                this.elements.solutionBtn.disabled = true;
                this.elements.skipBtn.disabled = true;
            }

            /**
             * Salta esercizio
             */
            skipExercise() {
                this.scoreManager.addPoints(0);

                this._showFeedback({
                    correct: false,
                    points: 0,
                    message: 'Esercizio saltato',
                    details: {}
                });

                this.elements.confirmBtn.disabled = true;
                this.elements.solutionBtn.disabled = true;
                this.elements.skipBtn.disabled = true;
            }

            /**
             * Mostra la soluzione senza penalit√†
             */
            showSolution() {
                this.scoreManager.addPoints(0);

                // Prepara il feedback con la soluzione corretta
                let feedbackData = {
                    correct: false,
                    points: 0,
                    message: 'üí° Soluzione mostrata',
                    details: {}
                };

                // Determina la soluzione in base al tipo di esercizio
                if (this.currentExercise instanceof NoteToFrettingExercise) {
                    // Tipo 1: mostra tutti i fretting possibili
                    feedbackData.details.correctAnswers = this.currentExercise.currentAnswer;
                    feedbackData.details.note = this.currentExercise.currentQuestion;
                } else if (this.currentExercise instanceof FrettingToNoteExercise) {
                    // Tipo 2: mostra la nota corretta
                    feedbackData.details.correctAnswer = this.currentExercise.currentAnswer;
                    feedbackData.details.fretting = this.currentExercise.currentQuestion;
                }

                this._showFeedback(feedbackData);

                // Disabilita bottoni
                this.elements.confirmBtn.disabled = true;
                this.elements.solutionBtn.disabled = true;
                this.elements.skipBtn.disabled = true;
            }

            // ===== PRIVATE METHODS =====

            _setupEventListeners() {
                this.elements.confirmBtn.onclick = () => this.confirmAnswer();
                this.elements.solutionBtn.onclick = () => this.showSolution();
                this.elements.skipBtn.onclick = () => this.skipExercise();
                this.elements.nextBtn.onclick = () => this.startNewExercise();

                // Auto-refresh quando cambiano i settings
                const exerciseTypeRadios = document.querySelectorAll('input[name="exercise-type"]');
                exerciseTypeRadios.forEach(radio => {
                    radio.addEventListener('change', () => this.startNewExercise());
                });

                const fretRangeRadios = document.querySelectorAll('input[name="fret-range"]');
                fretRangeRadios.forEach(radio => {
                    radio.addEventListener('change', () => this.startNewExercise());
                });

                // Toggle hint visibility
                const showHintCheckbox = document.getElementById('show-hint-checkbox');
                if (showHintCheckbox) {
                    showHintCheckbox.addEventListener('change', () => {
                        const noteHint = this.elements.noteHint;
                        if (showHintCheckbox.checked) {
                            noteHint.classList.remove('hidden');
                        } else {
                            noteHint.classList.add('hidden');
                        }
                    });
                }
            }

            _readSettings() {
                // Leggi tipo esercizio selezionato
                const exerciseTypeRadio = document.querySelector('input[name="exercise-type"]:checked');
                if (exerciseTypeRadio) {
                    this.settings.exerciseType = parseInt(exerciseTypeRadio.value);
                }

                // Leggi range fret selezionato
                const fretRangeRadio = document.querySelector('input[name="fret-range"]:checked');
                if (fretRangeRadio) {
                    this.settings.maxFrets = parseInt(fretRangeRadio.value);
                }
            }

            _resetUI() {
                // Nascondi feedback
                this.elements.feedback.classList.remove('show', 'success', 'error');
                this.elements.nextContainer.classList.add('hidden');

                // Abilita bottoni
                this.elements.confirmBtn.disabled = false;
                this.elements.solutionBtn.disabled = false;
                this.elements.skipBtn.disabled = false;

                // Pulisci staff
                this.staffRenderer.clear();
            }

            _setupNoteToFrettingUI(question) {
                // Mostra pentagramma
                this.elements.staffContainer.classList.remove('hidden');
                this.elements.frettingDisplay.classList.add('hidden');

                // Renderizza nota
                this.staffRenderer.render(question.note);

                // Mostra hint con un esempio di fretting e la nota
                const possibleFrettings = this.musicTheory.noteToFrettings(question.note);
                if (possibleFrettings.length > 0) {
                    const exampleFretting = possibleFrettings[0];
                    this.elements.noteHint.textContent = `es: ${exampleFretting} (${question.note})`;
                } else {
                    this.elements.noteHint.textContent = question.note;
                }

                // Setup tastiera fretting con maxFrets corrente
                this.currentKeyboard = new FrettingKeyboard('keyboard-container', this.settings.maxFrets);
                this.currentKeyboard.render();
            }

            _setupFrettingToNoteUI(question) {
                // Mostra fretting display
                this.elements.staffContainer.classList.add('hidden');
                this.elements.frettingDisplay.classList.remove('hidden');
                this.elements.frettingText.textContent = question.fretting;

                // Setup tastiera note
                this.currentKeyboard = new NoteKeyboard('keyboard-container');
                this.currentKeyboard.render();
            }

            _showFeedback(result) {
                const feedback = this.elements.feedback;

                // Imposta classe (success/error)
                feedback.classList.add('show');
                if (result.correct) {
                    feedback.classList.add('success');
                    feedback.classList.remove('error');
                    this.elements.feedbackIcon.textContent = '‚úì';
                } else {
                    feedback.classList.add('error');
                    feedback.classList.remove('success');
                    this.elements.feedbackIcon.textContent = '‚úó';
                }

                // Messaggio
                this.elements.feedbackMessage.textContent = result.message;

                // Dettagli
                let detailsHTML = '';

                if (result.details.correctAnswers && result.details.correctAnswers.length > 0) {
                    // Tipo 1: mostra alternative
                    const alternatives = result.details.correctAnswers;
                    console.log('Mostrando alternative:', alternatives);
                    detailsHTML = `
                        <div class="alternatives">
                            <div class="alternatives-title">Posizioni alternative:</div>
                            <div class="alternatives-list">${alternatives.join(', ')}</div>
                        </div>
                    `;
                } else if (result.details.correctAnswer) {
                    // Tipo 2: mostra risposta corretta
                    detailsHTML = `
                        <div>Risposta corretta: <strong>${result.details.correctAnswer}</strong></div>
                    `;
                } else {
                    // Debug: cosa abbiamo ricevuto?
                    console.log('Nessuna alternativa trovata. Details:', result.details);
                    detailsHTML = `<div style="color: var(--text-light);">Nessuna posizione disponibile nel range fret selezionato</div>`;
                }

                this.elements.feedbackDetails.innerHTML = detailsHTML;

                // Mostra bottone prossimo
                this.elements.nextContainer.classList.remove('hidden');
            }
        }

        // =====================================
        // INITIALIZATION
        // Avvia app al caricamento
        // =====================================
        window.addEventListener('DOMContentLoaded', () => {
            const app = new App();

            // Test mode: ?test=E1 o ?test=C2 per visualizzare nota specifica
            const urlParams = new URLSearchParams(window.location.search);
            const testNote = urlParams.get('test');

            if (testNote) {
                // Test mode: visualizza nota specifica
                console.log(`Test mode: visualizzando nota ${testNote}`);
                document.querySelector('.settings-panel').style.display = 'none';
                document.querySelector('.score-display').style.display = 'none';
                document.getElementById('exercise-question').innerHTML = `<h2>TEST MODE: Nota ${testNote}</h2>`;
                app.elements.staffContainer.classList.remove('hidden');
                app.staffRenderer.render(testNote);
                app.elements.keyboardContainer.innerHTML = '<p style="text-align: center; padding: 20px;">Modalit√† test - ricarica senza ?test per tornare al gioco</p>';
                document.querySelector('.action-buttons').style.display = 'none';
                document.getElementById('next-container').style.display = 'none';
            } else {
                app.start();
            }
        });
    </script>
</body>
</html>
